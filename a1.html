<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - 투자</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            zoom: 1;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        .screen {
            display: none;
            min-height: 100vh;
            position: relative;
        }
        .screen.active {
            display: block;
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4A6FA5, #6B8DC7);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 111, 165, 0.3);
        }
        .stock-item {
            transition: all 0.3s ease;
        }
        .stock-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .profit { color: #DC2626; }
        .loss { color: #2563EB; }
        
        .level-badge-nav {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        .level-badge-nav::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            border: 2px solid transparent;
            animation: glowing-border 3s infinite linear;
        }
        
        @keyframes glowing-border {
            0% { border-color: rgba(255, 255, 255, 0.2); transform: scale(1); }
            50% { border-color: rgba(255, 255, 255, 0.8); transform: scale(1.05); }
            100% { border-color: rgba(255, 255, 255, 0.2); transform: scale(1); }
        }

        .level-yellow { background: linear-gradient(135deg, #FCD34D, #F59E0B); }
        .level-orange { background: linear-gradient(135deg, #FB923C, #EA580C); }
        .level-green { background: linear-gradient(135deg, #34D399, #059669); }
        .level-blue { background: linear-gradient(135deg, #60A5FA, #2563EB); }
        .level-brown { background: linear-gradient(135deg, #A16207, #92400E); }
        .level-black { background: linear-gradient(135deg, #374151, #111827); }
        .level-red { background: linear-gradient(135deg, #EF4444, #DC2626); }
        
        .asset-category {
            border-left: 4px solid;
        }
        .asset-stock { border-color: #3B82F6; }
        .asset-bond { border-color: #10B981; }
        .asset-deposit { border-color: #8B5CF6; }
        .asset-etf { border-color: #F59E0B; }
        .asset-crypto { border-color: #EF4444; }
        .asset-commodity { border-color: #6B7280; }

        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 12px 0 8px 0;
            z-index: 50;
        }

        .nav-container {
            max-width: 28rem;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            align-items: end;
            position: relative;
            height: 60px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            transform: translateY(-1px);
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active i {
            color: #3B82F6;
        }

        .nav-item.active span {
            color: #3B82F6;
        }

        .nav-center {
            grid-column: 3;
            display: flex;
            justify-content: center;
            align-items: end;
            height: 100%;
            position: relative;
        }

        .investment-menu {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            z-index: 100;
            min-width: 200px;
        }

        .investment-menu.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .investment-menu-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .investment-menu-item:hover {
            background-color: #f3f4f6;
        }

        .investment-menu-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .modal {
            backdrop-filter: blur(10px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #ef4444;
        }

        #tradingModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        #tradingModal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .trading-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 20px;
        }
        
        .trading-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        
        .buy-button {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sell-button {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .buy-button:hover,
        .sell-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .trading-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .trading-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<!-- 주식 화면 -->
<div id="stockScreen" class="screen active">
    <div class="min-h-screen bg-gray-100">
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="navigateToPage('index.html')" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">주식 투자</h1>
                <button onclick="refreshStockData()" class="text-blue-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            <div class="bg-white rounded-xl p-4 card-shadow mb-6">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-search text-gray-400"></i>
                    <input type="text" id="stockSearch" placeholder="종목명 또는 종목코드 검색" 
                           class="flex-1 bg-transparent outline-none" onkeyup="searchStocks()">
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-lg font-bold mb-4">국내 주식</h2>
                <div id="domesticStocks" class="space-y-3">
                    <div class="text-center py-8">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-500">한국 주식 데이터 로딩 중...</p>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-lg font-bold mb-4">해외 주식</h2>
                <div id="foreignStocks" class="space-y-3">
                    <div class="text-center py-8">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-gray-500">해외 주식 데이터 로딩 중...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 암호화폐 화면 -->
<div id="cryptoScreen" class="screen">
    <div class="min-h-screen bg-gray-100">
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="showScreen('stockScreen')" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">암호화폐</h1>
                <button onclick="refreshCryptoData()" class="text-yellow-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            <div id="cryptoList" class="space-y-3 mb-24">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">암호화폐 데이터 로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 채권 화면 -->
<div id="bondScreen" class="screen">
    <div class="min-h-screen bg-gray-100">
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="showScreen('stockScreen')" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">채권 투자</h1>
                <button onclick="refreshBondData()" class="text-green-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            <div id="bondList" class="space-y-3 mb-24">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">채권 데이터 로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 예적금 화면 -->
<div id="depositScreen" class="screen">
    <div class="min-h-screen bg-gray-100">
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="showScreen('stockScreen')" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">예적금</h1>
                <button onclick="refreshDepositData()" class="text-purple-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            <div id="depositProducts" class="space-y-3 mb-24">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">예적금 상품 로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ETF/펀드 화면 -->
<div id="etfScreen" class="screen">
    <div class="min-h-screen bg-gray-100">
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="showScreen('stockScreen')" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">ETF/펀드</h1>
                <button onclick="refreshETFData()" class="text-orange-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            <div id="etfList" class="space-y-3 mb-24">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">ETF 데이터 로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 귀금속 화면 -->
<div id="commodityScreen" class="screen">
    <div class="min-h-screen bg-gray-100">
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="showScreen('stockScreen')" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">귀금속</h1>
                <button onclick="refreshCommodityData()" class="text-gray-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            <div id="commodityList" class="space-y-3 mb-24">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">귀금속 데이터 로딩 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 하단 네비게이션 -->
<div class="bottom-navigation">
    <div class="nav-container">
        <button onclick="navigateToPage('index.html')" class="nav-item">
            <i class="fas fa-home text-gray-400"></i>
            <span class="text-gray-400">홈</span>
        </button>
        <button onclick="navigateToPage('a2.html')" class="nav-item">
            <i class="fas fa-newspaper text-gray-400"></i>
            <span class="text-gray-400">뉴스</span>
        </button>
        <div class="nav-center">
            <div id="navLevelBadge" class="level-badge-nav level-yellow" onclick="toggleInvestmentMenu()">
                YELLOW
            </div>
        </div>
        <button onclick="navigateToPage('a4.html')" class="nav-item">
            <i class="fas fa-gamepad text-gray-400"></i>
            <span class="text-gray-400">게임</span>
        </button>
        <button onclick="navigateToPage('a3.html')" class="nav-item">
            <i class="fas fa-ellipsis-h text-gray-400"></i>
            <span class="text-gray-400">더보기</span>
        </button>
    </div>
</div>

<!-- 투자 메뉴 -->
<div id="investmentMenu" class="investment-menu">
    <div class="investment-menu-item" onclick="showScreen('stockScreen')">
        <i class="fas fa-chart-line text-blue-500"></i>
        <span>주식</span>
    </div>
    <div class="investment-menu-item" onclick="showScreen('cryptoScreen')">
        <i class="fas fa-coins text-yellow-500"></i>
        <span>암호화폐</span>
    </div>
    <div class="investment-menu-item" onclick="showScreen('bondScreen')">
        <i class="fas fa-certificate text-green-500"></i>
        <span>채권</span>
    </div>
    <div class="investment-menu-item" onclick="showScreen('depositScreen')">
        <i class="fas fa-piggy-bank text-purple-500"></i>
        <span>예적금</span>
    </div>
    <div class="investment-menu-item" onclick="showScreen('etfScreen')">
        <i class="fas fa-layer-group text-orange-500"></i>
        <span>ETF/펀드</span>
    </div>
    <div class="investment-menu-item" onclick="showScreen('commodityScreen')">
        <i class="fas fa-gem text-gray-500"></i>
        <span>귀금속</span>
    </div>
</div>

<!-- 트레이딩 모달 -->
<div id="tradingModal">
    <div class="trading-modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 id="tradingAssetName" class="text-xl font-bold">자산 거래</h3>
            <button onclick="closeTradingModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <div class="flex justify-between items-center">
                <span id="tradingCurrentPrice" class="text-2xl font-bold">$0.00</span>
                <span id="tradingPriceChange" class="text-sm">+0.00%</span>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="tradingChart" style="height: 250px;"></canvas>
        </div>
        
        <div class="trading-input">
            <span class="text-sm text-gray-600">수량:</span>
            <input type="number" id="tradingQuantity" value="1" min="0.01" step="0.01" class="trading-input-field">
            <span class="text-sm text-gray-600">개</span>
        </div>
        
        <div class="trading-input">
            <span class="text-sm text-gray-600">총액:</span>
            <span id="tradingTotalAmount" class="font-bold">$0.00</span>
        </div>
        
        <div class="trading-buttons">
            <button id="buyButton" class="buy-button" onclick="executeTrade('buy')">
                매수 <i class="fas fa-arrow-up ml-1"></i>
            </button>
            <button id="sellButton" class="sell-button" onclick="executeTrade('sell')">
                매도 <i class="fas fa-arrow-down ml-1"></i>
            </button>
        </div>
    </div>
</div>

<script>
// 전역 변수
var currentUser = null;
var currentTradingAsset = null;
var tradingChart = null;

var levelSystem = {
    yellow: { name: 'YELLOW', exp: 0, max: 3000, class: 'level-yellow' },
    orange: { name: 'ORANGE', exp: 3000, max: 6000, class: 'level-orange' },
    green: { name: 'GREEN', exp: 6000, max: 10000, class: 'level-green' },
    blue: { name: 'BLUE', exp: 10000, max: 15000, class: 'level-blue' },
    brown: { name: 'BROWN', exp: 15000, max: 25000, class: 'level-brown' },
    black: { name: 'BLACK', exp: 25000, max: 50000, class: 'level-black' },
    red: { name: 'RED', exp: 50000, max: 100000, class: 'level-red' }
};

// --- 데이터 연동 로직 ---
function loadUserData() {
    try {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
        } else {
            window.location.href = 'index.html'; // 로그인 정보 없으면 홈으로
        }
    } catch (error) {
        console.error("데이터 로드 오류:", error);
        window.location.href = 'index.html';
    }
}

function saveUserData() {
    if (currentUser) {
        try {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        } catch (error) {
            console.error("데이터 저장 오류:", error);
        }
    }
}

function navigateToPage(page) {
    saveUserData();
    window.location.href = page + '?v=' + new Date().getTime();
}

// 화면 전환
function showScreen(screenId) {
    try {
        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        hideInvestmentMenu();
        
        switch(screenId) {
            case 'stockScreen': loadKoreanStocks(); loadForeignStocks(); break;
            case 'cryptoScreen': loadRealCryptoData(); break;
            case 'bondScreen': loadBondData(); break;
            case 'depositScreen': loadDepositData(); break;
            case 'etfScreen': loadETFData(); break;
            case 'commodityScreen': loadCommodityData(); break;
        }
    } catch (error) {
        console.error('화면 전환 오류:', error);
    }
}

// API 호출 래퍼 (CORS 우회)
async function fetchWithProxy(url) {
    const proxyUrl = 'https://api.allorigins.win/raw?url=';
    try {
        const response = await fetch(proxyUrl + encodeURIComponent(url));
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    } catch (error) {
        console.error('API Fetch Error:', error);
        return null;
    }
}

// 한국 주식 데이터 로드 (실시간 API)
async function loadKoreanStocks() {
    const container = document.getElementById('domesticStocks');
    container.innerHTML = `<div class="text-center py-4"><div class="loading mx-auto mb-4"></div><p class="text-gray-500">한국 주식 데이터 로딩 중...</p></div>`;
    
    const koreanStocks = [
        { symbol: '005930.KS', name: '삼성전자', code: '005930' },
        { symbol: '000660.KS', name: 'SK하이닉스', code: '000660' },
        { symbol: '373220.KS', name: 'LG에너지솔루션', code: '373220' },
        { symbol: '035420.KS', name: 'NAVER', code: '035420' },
        { symbol: '005380.KS', name: '현대차', code: '005380' }
    ];

    const promises = koreanStocks.map(stock => fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${stock.symbol}`));
    const results = await Promise.all(promises);
    
    container.innerHTML = '';
    results.forEach((data, index) => {
        if (data && data.chart && data.chart.result && data.chart.result[0]) {
            const result = data.chart.result[0];
            const meta = result.meta;
            const stock = {
                ...koreanStocks[index],
                price: meta.regularMarketPrice,
                change: meta.regularMarketPrice - meta.previousClose,
                changePercent: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100
            };
            
            const changeClass = stock.change >= 0 ? 'text-red-600' : 'text-blue-600';
            const changeSymbol = stock.change >= 0 ? '+' : '';
            
            const stockItem = document.createElement('div');
            stockItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-stock cursor-pointer stock-item';
            stockItem.onclick = () => openTradingModal(stock, 'stock');
            
            stockItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div><p class="font-semibold">${stock.name}</p><p class="text-sm text-gray-500">${stock.code}</p></div>
                    <div class="text-right"><p class="font-bold">₩${Math.floor(stock.price).toLocaleString()}</p><p class="text-sm ${changeClass}">${changeSymbol}${stock.changePercent.toFixed(2)}%</p></div>
                </div>`;
            container.appendChild(stockItem);
        }
    });

    if (container.children.length === 0) {
        container.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><p>데이터를 불러올 수 없습니다. 잠시 후 다시 시도해주세요.</p></div>`;
    }
}

// 해외 주식 데이터 로드 (실시간 API)
async function loadForeignStocks() {
    const container = document.getElementById('foreignStocks');
    container.innerHTML = `<div class="text-center py-4"><div class="loading mx-auto mb-4"></div><p class="text-gray-500">해외 주식 데이터 로딩 중...</p></div>`;

    const foreignStocks = [
        { symbol: 'AAPL', name: 'Apple' }, { symbol: 'MSFT', name: 'Microsoft' },
        { symbol: 'GOOGL', name: 'Alphabet' }, { symbol: 'TSLA', name: 'Tesla' },
        { symbol: 'NVDA', name: 'NVIDIA' }
    ];

    const promises = foreignStocks.map(stock => fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${stock.symbol}`));
    const results = await Promise.all(promises);

    container.innerHTML = '';
    results.forEach((data, index) => {
        if (data && data.chart && data.chart.result && data.chart.result[0]) {
            const result = data.chart.result[0];
            const meta = result.meta;
            const stock = {
                ...foreignStocks[index],
                price: meta.regularMarketPrice,
                change: meta.regularMarketPrice - meta.previousClose,
                changePercent: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100
            };
            
            const changeClass = stock.change >= 0 ? 'text-red-600' : 'text-blue-600';
            const changeSymbol = stock.change >= 0 ? '+' : '';
            
            const stockItem = document.createElement('div');
            stockItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-stock cursor-pointer stock-item';
            stockItem.onclick = () => openTradingModal(stock, 'stock');
            
            stockItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div><p class="font-semibold">${stock.name}</p><p class="text-sm text-gray-500">${stock.symbol}</p></div>
                    <div class="text-right"><p class="font-bold">$${stock.price.toFixed(2)}</p><p class="text-sm ${changeClass}">${changeSymbol}${stock.changePercent.toFixed(2)}%</p></div>
                </div>`;
            container.appendChild(stockItem);
        }
    });
    
    if (container.children.length === 0) {
        container.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><p>데이터를 불러올 수 없습니다. 잠시 후 다시 시도해주세요.</p></div>`;
    }
}

// 암호화폐 데이터 로드 (실시간 API)
async function loadRealCryptoData() {
    const container = document.getElementById('cryptoList');
    container.innerHTML = `<div class="text-center py-8"><div class="loading mx-auto mb-4"></div><p class="text-gray-500">암호화폐 데이터 로딩 중...</p></div>`;

    const cryptoData = await fetchWithProxy('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1');
    
    if (!cryptoData) {
        container.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><p>데이터를 불러올 수 없습니다. 잠시 후 다시 시도해주세요.</p></div>`;
        return;
    }

    container.innerHTML = '';
    cryptoData.forEach(crypto => {
        const changeClass = crypto.price_change_percentage_24h >= 0 ? 'text-red-600' : 'text-blue-600';
        const changeSymbol = crypto.price_change_percentage_24h >= 0 ? '+' : '';
        
        const cryptoItem = document.createElement('div');
        cryptoItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-crypto cursor-pointer stock-item';
        cryptoItem.onclick = () => openTradingModal(crypto, 'crypto');
        
        cryptoItem.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img src="${crypto.image}" alt="${crypto.name}" class="w-10 h-10 rounded-full">
                    <div><p class="font-semibold">${crypto.name}</p><p class="text-sm text-gray-500">${crypto.symbol.toUpperCase()}</p></div>
                </div>
                <div class="text-right"><p class="font-bold">$${crypto.current_price.toLocaleString()}</p><p class="text-sm ${changeClass}">${changeSymbol}${(crypto.price_change_percentage_24h || 0).toFixed(2)}%</p></div>
            </div>`;
        container.appendChild(cryptoItem);
    });
}

// 나머지 자산 데이터 로드 함수 (임시 데이터 사용)
function loadBondData() {
    var container = document.getElementById('bondList');
    var bondData = [
        { name: '국고채권 3년', rate: '3.25%', maturity: '2027-01-15', risk: '낮음', price: 10000 },
        { name: '회사채 AA- 3년', rate: '4.15%', maturity: '2027-03-20', risk: '보통', price: 10000 },
    ];
    container.innerHTML = '';
    bondData.forEach(bond => {
        var bondItem = document.createElement('div');
        bondItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-bond cursor-pointer stock-item';
        bondItem.onclick = () => openTradingModal(bond, 'bond');
        bondItem.innerHTML = `
            <div class="flex justify-between items-center">
                <div><p class="font-semibold">${bond.name}</p><p class="text-sm text-gray-500">만기: ${bond.maturity}</p></div>
                <div class="text-right"><p class="font-bold">${bond.rate}</p><p class="text-sm text-green-600">위험도: ${bond.risk}</p></div>
            </div>`;
        container.appendChild(bondItem);
    });
}
function loadDepositData() {
    var container = document.getElementById('depositProducts');
    var depositData = [
        { name: 'KB국민은행 정기예금', rate: '3.50%', period: '12개월', bank: 'KB국민은행', price: 10000 },
        { name: '신한은행 적금', rate: '3.80%', period: '24개월', bank: '신한은행', price: 10000 },
    ];
    container.innerHTML = '';
    depositData.forEach(product => {
        var productItem = document.createElement('div');
        productItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-deposit cursor-pointer stock-item';
        productItem.onclick = () => openTradingModal(product, 'deposit');
        productItem.innerHTML = `
            <div class="flex justify-between items-center">
                <div><p class="font-semibold">${product.name}</p><p class="text-sm text-gray-500">${product.bank} · ${product.period}</p></div>
                <div class="text-right"><p class="font-bold text-blue-600">${product.rate}</p><p class="text-sm text-gray-500">연 이자율</p></div>
            </div>`;
        container.appendChild(productItem);
    });
}
function loadETFData() {
    var container = document.getElementById('etfList');
    var etfData = [
        { name: 'KODEX 200', code: '069500', price: 42500, change: 1.2 },
        { name: 'TIGER 미국S&P500', code: '360750', price: 15800, change: -0.5 },
    ];
    container.innerHTML = '';
    etfData.forEach(etf => {
        var changeClass = etf.change >= 0 ? 'text-red-600' : 'text-blue-600';
        var changeSymbol = etf.change >= 0 ? '+' : '';
        var etfItem = document.createElement('div');
        etfItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-etf cursor-pointer stock-item';
        etfItem.onclick = () => openTradingModal(etf, 'etf');
        etfItem.innerHTML = `
            <div class="flex justify-between items-center">
                <div><p class="font-semibold">${etf.name}</p><p class="text-sm text-gray-500">${etf.code}</p></div>
                <div class="text-right"><p class="font-bold">₩${etf.price.toLocaleString()}</p><p class="text-sm ${changeClass}">${changeSymbol}${etf.change.toFixed(2)}%</p></div>
            </div>`;
        container.appendChild(etfItem);
    });
}
function loadCommodityData() {
    var container = document.getElementById('commodityList');
    var commodityData = [
        { name: '금 (Gold)', unit: '1g', price: 82500, change: 0.8 },
        { name: '은 (Silver)', unit: '1g', price: 1050, change: -1.2 },
    ];
    container.innerHTML = '';
    commodityData.forEach(commodity => {
        var changeClass = commodity.change >= 0 ? 'text-red-600' : 'text-blue-600';
        var changeSymbol = commodity.change >= 0 ? '+' : '';
        var commodityItem = document.createElement('div');
        commodityItem.className = 'bg-white rounded-xl p-4 card-shadow asset-category asset-commodity cursor-pointer stock-item';
        commodityItem.onclick = () => openTradingModal(commodity, 'commodity');
        commodityItem.innerHTML = `
            <div class="flex justify-between items-center">
                <div><p class="font-semibold">${commodity.name}</p><p class="text-sm text-gray-500">${commodity.unit}</p></div>
                <div class="text-right"><p class="font-bold">₩${commodity.price.toLocaleString()}</p><p class="text-sm ${changeClass}">${changeSymbol}${commodity.change.toFixed(2)}%</p></div>
            </div>`;
        container.appendChild(commodityItem);
    });
}


// 트레이딩 모달 열기
function openTradingModal(asset, type) {
    // ... 기존 코드와 동일
}
function closeTradingModal() {
    // ... 기존 코드와 동일
}
function createTradingChart(asset, type) {
    // ... 기존 코드와 동일
}
function updateTotalAmount() {
    // ... 기존 코드와 동일
}
function executeTrade(action) {
    // ... 기존 코드와 동일, 단 마지막에 saveUserData() 호출 추가
    saveUserData();
}
function toggleInvestmentMenu() {
    document.getElementById('investmentMenu').classList.toggle('show');
}
function hideInvestmentMenu() {
    document.getElementById('investmentMenu').classList.remove('show');
}
function refreshStockData() { loadKoreanStocks(); loadForeignStocks(); }
function refreshCryptoData() { loadRealCryptoData(); }
function refreshBondData() { loadBondData(); }
function refreshDepositData() { loadDepositData(); }
function refreshETFData() { loadETFData(); }
function refreshCommodityData() { loadCommodityData(); }
function searchStocks() { /* 검색 기능 구현 */ }

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadUserData(); // 데이터 로드
    if (!currentUser) return; // 로그인 안됐으면 중단

    try {
        var userLevel = currentUser.level || 'yellow';
        var levelBadge = document.getElementById('navLevelBadge');
        if (levelBadge && levelSystem[userLevel]) {
            levelBadge.className = 'level-badge-nav ' + levelSystem[userLevel].class;
            levelBadge.textContent = levelSystem[userLevel].name;
        }
        
        loadKoreanStocks();
        loadForeignStocks();
        
        document.getElementById('tradingModal').addEventListener('click', e => {
            if (e.target.id === 'tradingModal') closeTradingModal();
        });
        
        document.addEventListener('click', e => {
            var menu = document.getElementById('investmentMenu');
            var levelBadge = document.getElementById('navLevelBadge');
            if (menu && menu.classList.contains('show') && !menu.contains(e.target) && !levelBadge.contains(e.target)) {
                hideInvestmentMenu();
            }
        });
        
    } catch (error) {
        console.error('초기화 오류:', error);
    }
});

window.addEventListener('beforeunload', saveUserData);
</script>

</body>
</html>
