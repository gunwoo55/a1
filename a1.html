<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투자 - FinLearn</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #667eea;
        }

        .nav-links a.active {
            color: #667eea;
            font-weight: bold;
        }

        .nav-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .level-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            animation: glowPulse 2s infinite;
        }

        @keyframes glowPulse {
            0%, 100% { 
                box-shadow: 0 0 5px currentColor;
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
                transform: scale(1.05);
            }
        }

        .glow {
            animation: glowPulse 2s infinite;
        }

        .level-yellow { background: #f39c12; }
        .level-orange { background: #e67e22; }
        .level-green { background: #27ae60; }
        .level-blue { background: #3498db; }
        .level-brown { background: #8b4513; }
        .level-black { background: #2c3e50; }
        .level-red { background: #e74c3c; }

        /* Investment Dashboard */
        .investment-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .investment-header h1 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .summary-card {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Investment Categories */
        .investment-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .category-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .category-header h3 {
            color: #667eea;
            font-size: 1.3rem;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .asset-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .asset-info {
            flex: 1;
        }

        .asset-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .asset-code {
            font-size: 0.8rem;
            color: #666;
        }

        .asset-price {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.2rem;
        }

        .current-price {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .price-change {
            font-size: 0.9rem;
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
        }

        .price-up {
            color: #e74c3c;
            background: #ffeaea;
        }

        .price-down {
            color: #27ae60;
            background: #eafaf1;
        }

        .asset-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-buy {
            background: #e74c3c;
            color: white;
        }

        .btn-buy:hover {
            background: #c0392b;
        }

        .btn-sell {
            background: #27ae60;
            color: white;
        }

        .btn-sell:hover {
            background: #219a52;
        }

        .btn-disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* Portfolio Section */
        .portfolio-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 2rem;
        }

        .portfolio-section h3 {
            color: #667eea;
            margin-bottom: 1.5rem;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e1e1e1;
        }

        .portfolio-item:last-child {
            border-bottom: none;
        }

        .holding-info {
            flex: 1;
        }

        .holding-name {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .holding-quantity {
            font-size: 0.9rem;
            color: #666;
        }

        .holding-value {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .current-value {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .profit-loss {
            font-size: 0.9rem;
        }

        .profit {
            color: #e74c3c;
        }

        .loss {
            color: #27ae60;
        }

        /* Trading Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            min-width: 400px;
        }

        .modal h3 {
            color: #667eea;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-primary {
            flex: 1;
            padding: 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-secondary {
            flex: 1;
            padding: 1rem;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 1rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-brand">💰 FinLearn</div>
            <ul class="nav-links">
                <li><a href="index.html">홈</a></li>
                <li><a href="a1.html" class="active">투자</a></li>
                <li><a href="a2.html">뉴스</a></li>
                <li><a href="a3.html">더보기</a></li>
                <li><a href="a4.html">게임</a></li>
                <li><a href="a5.html">등급</a></li>
            </ul>
            <div class="nav-profile">
                <img id="navProfileImg" class="profile-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23667eea'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16'%3E👤%3C/text%3E%3C/svg%3E" alt="프로필">
                <span id="navLevelBadge" class="level-badge glow level-yellow">YELLOW</span>
            </div>
        </nav>

        <!-- Investment Header -->
        <div class="investment-header">
            <h1>📈 투자 대시보드</h1>
            <p>모의 투자로 경험을 쌓고 EXP를 획득하세요!</p>
            
            <div class="portfolio-summary">
                <div class="summary-card">
                    <div id="totalAssets" class="summary-value">0원</div>
                    <div class="summary-label">총 자산</div>
                </div>
                <div class="summary-card">
                    <div id="totalProfit" class="summary-value">0원</div>
                    <div class="summary-label">총 수익</div>
                </div>
                <div class="summary-card">
                    <div id="totalReturn" class="summary-value">0%</div>
                    <div class="summary-label">수익률</div>
                </div>
                <div class="summary-card">
                    <div id="availableCash" class="summary-value">100,000원</div>
                    <div class="summary-label">가용 자금</div>
                </div>
            </div>
        </div>

        <!-- Investment Categories -->
        <div class="investment-categories">
            <!-- 국내 주식 -->
            <div class="category-card">
                <div class="category-header">
                    <h3>🇰🇷 국내 주식</h3>
                    <button class="refresh-btn" onclick="refreshStockPrices('domestic')">새로고침</button>
                </div>
                <div id="domesticStocks" class="asset-list">
                    <div class="loading">주식 가격을 불러오는 중...</div>
                </div>
            </div>

            <!-- 해외 주식 -->
            <div class="category-card">
                <div class="category-header">
                    <h3>🇺🇸 해외 주식</h3>
                    <button class="refresh-btn" onclick="refreshStockPrices('international')">새로고침</button>
                </div>
                <div id="internationalStocks" class="asset-list">
                    <div class="loading">주식 가격을 불러오는 중...</div>
                </div>
            </div>

            <!-- 암호화폐 -->
            <div class="category-card">
                <div class="category-header">
                    <h3>₿ 암호화폐</h3>
                    <button class="refresh-btn" onclick="refreshCryptoPrices()">새로고침</button>
                </div>
                <div id="cryptoAssets" class="asset-list">
                    <div class="loading">암호화폐 가격을 불러오는 중...</div>
                </div>
            </div>

            <!-- ETF -->
            <div class="category-card">
                <div class="category-header">
                    <h3>📊 ETF</h3>
                    <button class="refresh-btn" onclick="refreshETFPrices()">새로고침</button>
                </div>
                <div id="etfAssets" class="asset-list">
                    <div class="loading">ETF 가격을 불러오는 중...</div>
                </div>
            </div>
        </div>

        <!-- Portfolio -->
        <div class="portfolio-section">
            <h3>💼 내 포트폴리오</h3>
            <div id="portfolioList">
                <div class="loading">포트폴리오를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <!-- Trading Modal -->
    <div id="tradingModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">거래</h3>
            <form id="tradingForm">
                <div class="form-group">
                    <label>종목명</label>
                    <input type="text" id="assetName" readonly>
                </div>
                <div class="form-group">
                    <label>현재가</label>
                    <input type="text" id="currentPrice" readonly>
                </div>
                <div class="form-group">
                    <label for="quantity">수량</label>
                    <input type="number" id="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>총 금액</label>
                    <input type="text" id="totalAmount" readonly>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">확인</button>
                    <button type="button" class="btn-secondary" onclick="closeTradingModal()">취소</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Mock data for demonstration
        const STOCK_DATA = {
            domestic: [
                { name: '삼성전자', code: '005930', price: 75000, change: 1.2 },
                { name: 'LG에너지솔루션', code: '373220', price: 420000, change: -0.8 },
                { name: 'SK하이닉스', code: '000660', price: 125000, change: 2.1 },
                { name: 'NAVER', code: '035420', price: 180000, change: -1.5 }
            ],
            international: [
                { name: 'Apple Inc.', code: 'AAPL', price: 175.25, change: 0.8 },
                { name: 'Microsoft Corp.', code: 'MSFT', price: 378.85, change: 1.2 },
                { name: 'Tesla Inc.', code: 'TSLA', price: 248.50, change: -2.1 },
                { name: 'Amazon.com Inc.', code: 'AMZN', price: 155.89, change: 0.5 }
            ]
        };

        const CRYPTO_DATA = [
            { name: '비트코인', code: 'BTC', price: 43250.75, change: 2.4 },
            { name: '이더리움', code: 'ETH', price: 2630.40, change: -1.1 },
            { name: '리플', code: 'XRP', price: 0.52, change: 5.2 },
            { name: '솔라나', code: 'SOL', price: 95.30, change: -0.9 }
        ];

        const ETF_DATA = [
            { name: 'KODEX 200', code: '069500', price: 34250, change: 0.7 },
            { name: 'TIGER 나스닥100', code: '133690', price: 22480, change: 1.3 },
            { name: 'KODEX 코스닥150', code: '229200', price: 8940, change: -0.4 },
            { name: 'ARIRANG 선진국MSCI', code: '195930', price: 12750, change: 0.9 }
        ];

        let currentTrade = null;
        let portfolio = JSON.parse(localStorage.getItem('portfolio') || '[]');
        let availableCash = parseFloat(localStorage.getItem('availableCash') || '100000');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadMarketData();
            updatePortfolio();
            setupEventListeners();
        });

        function initializePage() {
            // Load user interface if FinLearnUtils is available
            if (window.FinLearnUtils) {
                updateUserInterface();
            }
        }

        function updateUserInterface() {
            const currentUser = getCurrentUser();
            if (currentUser && currentUser.isLoggedIn) {
                // Update profile image
                if (currentUser.profileImage) {
                    document.getElementById('navProfileImg').src = currentUser.profileImage;
                }
                
                // Update level badge
                const level = getLevelFromExp(currentUser.exp);
                updateLevelBadges(level);
            }
        }

        function getCurrentUser() {
            const userData = localStorage.getItem('currentUser');
            return userData ? JSON.parse(userData) : null;
        }

        function getLevelFromExp(exp) {
            const levels = ['yellow', 'orange', 'green', 'blue', 'brown', 'black', 'red'];
            const thresholds = [0, 3000, 6000, 10000, 15000, 25000, 50000];
            
            for (let i = levels.length - 1; i >= 0; i--) {
                if (exp >= thresholds[i]) {
                    return levels[i];
                }
            }
            return 'yellow';
        }

        function updateLevelBadges(level) {
            const levelNames = {
                yellow: 'YELLOW',
                orange: 'ORANGE', 
                green: 'GREEN',
                blue: 'BLUE',
                brown: 'BROWN',
                black: 'BLACK',
                red: 'RED'
            };
            
            const badge = document.getElementById('navLevelBadge');
            if (badge) {
                badge.textContent = levelNames[level];
                badge.className = `level-badge glow level-${level}`;
            }
        }

        function setupEventListeners() {
            // Trading form
            document.getElementById('tradingForm').addEventListener('submit', handleTrade);
            document.getElementById('quantity').addEventListener('input', updateTotalAmount);
            
            // Close modal when clicking outside
            document.getElementById('tradingModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTradingModal();
                }
            });
        }

        function loadMarketData() {
            // Load domestic stocks
            loadStockData('domestic', STOCK_DATA.domestic);
            // Load international stocks  
            loadStockData('international', STOCK_DATA.international);
            // Load crypto data
            loadCryptoData();
            // Load ETF data
            loadETFData();
        }

        function loadStockData(type, data) {
            const containerId = type === 'domestic' ? 'domesticStocks' : 'internationalStocks';
            const container = document.getElementById(containerId);
            
            // Simulate API call with placeholder hooks
            fetchStockPrices(type, data).then(stocks => {
                const html = stocks.map(stock => createAssetHTML(stock, 'stock')).join('');
                container.innerHTML = html;
            }).catch(error => {
                container.innerHTML = `<div class="error">주식 데이터를 불러오는데 실패했습니다: ${error.message}</div>`;
            });
        }

        function loadCryptoData() {
            // Simulate API call with CoinGecko placeholder
            fetchCryptoPrices(CRYPTO_DATA).then(cryptos => {
                const html = cryptos.map(crypto => createAssetHTML(crypto, 'crypto')).join('');
                document.getElementById('cryptoAssets').innerHTML = html;
            }).catch(error => {
                document.getElementById('cryptoAssets').innerHTML = `<div class="error">암호화폐 데이터를 불러오는데 실패했습니다: ${error.message}</div>`;
            });
        }

        function loadETFData() {
            // Simulate API call for ETF data
            fetchETFPrices(ETF_DATA).then(etfs => {
                const html = etfs.map(etf => createAssetHTML(etf, 'etf')).join('');
                document.getElementById('etfAssets').innerHTML = html;
            }).catch(error => {
                document.getElementById('etfAssets').innerHTML = `<div class="error">ETF 데이터를 불러오는데 실패했습니다: ${error.message}</div>`;
            });
        }

        // API placeholder functions - these would connect to real APIs
        async function fetchStockPrices(type, fallbackData) {
            // Yahoo Finance API placeholder
            // const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`);
            
            // Simulate API delay and return mock data
            await new Promise(resolve => setTimeout(resolve, 500));
            return fallbackData.map(item => ({
                ...item,
                price: item.price * (0.98 + Math.random() * 0.04), // Add some randomness
                change: (Math.random() - 0.5) * 4 // Random change between -2% and +2%
            }));
        }

        async function fetchCryptoPrices(fallbackData) {
            // CoinGecko API placeholder  
            // const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd');
            
            await new Promise(resolve => setTimeout(resolve, 300));
            return fallbackData.map(item => ({
                ...item,
                price: item.price * (0.95 + Math.random() * 0.1), // Add volatility
                change: (Math.random() - 0.5) * 8 // More volatile changes
            }));
        }

        async function fetchETFPrices(fallbackData) {
            // ETF API placeholder
            await new Promise(resolve => setTimeout(resolve, 400));
            return fallbackData.map(item => ({
                ...item,
                price: item.price * (0.99 + Math.random() * 0.02),
                change: (Math.random() - 0.5) * 2
            }));
        }

        function createAssetHTML(asset, type) {
            const changeClass = asset.change >= 0 ? 'price-up' : 'price-down';
            const changeSymbol = asset.change >= 0 ? '+' : '';
            const priceFormatted = type === 'international' || type === 'crypto' ? 
                `$${asset.price.toFixed(2)}` : `${Math.round(asset.price).toLocaleString()}원`;
            
            return `
                <div class="asset-item">
                    <div class="asset-info">
                        <div class="asset-name">${asset.name}</div>
                        <div class="asset-code">${asset.code}</div>
                    </div>
                    <div class="asset-price">
                        <div class="current-price">${priceFormatted}</div>
                        <div class="price-change ${changeClass}">${changeSymbol}${asset.change.toFixed(2)}%</div>
                    </div>
                    <div class="asset-actions">
                        <button class="btn btn-buy" onclick="openTradingModal('${asset.name}', '${asset.code}', ${asset.price}, 'buy', '${type}')">매수</button>
                        <button class="btn btn-sell ${getHoldingQuantity(asset.code) > 0 ? '' : 'btn-disabled'}" 
                                onclick="openTradingModal('${asset.name}', '${asset.code}', ${asset.price}, 'sell', '${type}')"
                                ${getHoldingQuantity(asset.code) > 0 ? '' : 'disabled'}>매도</button>
                    </div>
                </div>
            `;
        }

        function openTradingModal(name, code, price, action, type) {
            currentTrade = { name, code, price, action, type };
            
            document.getElementById('modalTitle').textContent = action === 'buy' ? '매수' : '매도';
            document.getElementById('assetName').value = name;
            document.getElementById('currentPrice').value = type === 'international' || type === 'crypto' ? 
                `$${price.toFixed(2)}` : `${Math.round(price).toLocaleString()}원`;
            document.getElementById('quantity').value = '';
            document.getElementById('quantity').max = action === 'sell' ? getHoldingQuantity(code) : '';
            document.getElementById('totalAmount').value = '';
            
            document.getElementById('tradingModal').style.display = 'block';
        }

        function closeTradingModal() {
            document.getElementById('tradingModal').style.display = 'none';
            currentTrade = null;
        }

        function updateTotalAmount() {
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const total = quantity * currentTrade.price;
            
            const totalFormatted = currentTrade.type === 'international' || currentTrade.type === 'crypto' ? 
                `$${total.toFixed(2)}` : `${Math.round(total).toLocaleString()}원`;
            
            document.getElementById('totalAmount').value = totalFormatted;
        }

        function handleTrade(e) {
            e.preventDefault();
            
            const quantity = parseInt(document.getElementById('quantity').value);
            const total = quantity * currentTrade.price;
            
            if (currentTrade.action === 'buy') {
                if (total > availableCash) {
                    alert('가용 자금이 부족합니다.');
                    return;
                }
                
                // Execute buy order
                availableCash -= total;
                addToPortfolio(currentTrade.code, currentTrade.name, quantity, currentTrade.price, currentTrade.type);
                
                // Add EXP for trading
                if (window.FinLearnUtils) {
                    window.FinLearnUtils.addExp(Math.min(100, Math.floor(total / 1000)));
                }
                
                alert(`${currentTrade.name} ${quantity}주를 매수했습니다.`);
                
            } else {
                // Execute sell order
                const holding = portfolio.find(p => p.code === currentTrade.code);
                if (holding && holding.quantity >= quantity) {
                    availableCash += total;
                    holding.quantity -= quantity;
                    if (holding.quantity === 0) {
                        portfolio = portfolio.filter(p => p.code !== currentTrade.code);
                    }
                    
                    // Add EXP for trading
                    if (window.FinLearnUtils) {
                        window.FinLearnUtils.addExp(Math.min(100, Math.floor(total / 1000)));
                    }
                    
                    alert(`${currentTrade.name} ${quantity}주를 매도했습니다.`);
                }
            }
            
            // Update localStorage
            localStorage.setItem('portfolio', JSON.stringify(portfolio));
            localStorage.setItem('availableCash', availableCash.toString());
            
            // Update UI
            updatePortfolio();
            loadMarketData(); // Refresh to update buy/sell button states
            closeTradingModal();
        }

        function addToPortfolio(code, name, quantity, price, type) {
            const existing = portfolio.find(p => p.code === code);
            if (existing) {
                // Average price calculation
                const totalValue = (existing.quantity * existing.avgPrice) + (quantity * price);
                const totalQuantity = existing.quantity + quantity;
                existing.avgPrice = totalValue / totalQuantity;
                existing.quantity = totalQuantity;
            } else {
                portfolio.push({
                    code,
                    name,
                    quantity,
                    avgPrice: price,
                    type
                });
            }
        }

        function getHoldingQuantity(code) {
            const holding = portfolio.find(p => p.code === code);
            return holding ? holding.quantity : 0;
        }

        function updatePortfolio() {
            // Update available cash
            document.getElementById('availableCash').textContent = `${Math.round(availableCash).toLocaleString()}원`;
            
            // Update portfolio list
            const portfolioContainer = document.getElementById('portfolioList');
            
            if (portfolio.length === 0) {
                portfolioContainer.innerHTML = '<div class="loading">보유 중인 투자 상품이 없습니다.</div>';
                return;
            }
            
            const portfolioHTML = portfolio.map(holding => {
                // Get current price (simplified - in real app would fetch from market data)
                const currentPrice = getCurrentPrice(holding.code, holding.type);
                const currentValue = holding.quantity * currentPrice;
                const investedValue = holding.quantity * holding.avgPrice;
                const profitLoss = currentValue - investedValue;
                const profitLossPercent = (profitLoss / investedValue) * 100;
                
                const profitClass = profitLoss >= 0 ? 'profit' : 'loss';
                const profitSymbol = profitLoss >= 0 ? '+' : '';
                
                return `
                    <div class="portfolio-item">
                        <div class="holding-info">
                            <div class="holding-name">${holding.name}</div>
                            <div class="holding-quantity">${holding.quantity}주 • 평균가: ${Math.round(holding.avgPrice).toLocaleString()}원</div>
                        </div>
                        <div class="holding-value">
                            <div class="current-value">${Math.round(currentValue).toLocaleString()}원</div>
                            <div class="profit-loss ${profitClass}">
                                ${profitSymbol}${Math.round(profitLoss).toLocaleString()}원 (${profitSymbol}${profitLossPercent.toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            portfolioContainer.innerHTML = portfolioHTML;
            
            // Update summary
            const totalAssets = availableCash + portfolio.reduce((sum, holding) => {
                return sum + (holding.quantity * getCurrentPrice(holding.code, holding.type));
            }, 0);
            
            const totalInvested = portfolio.reduce((sum, holding) => {
                return sum + (holding.quantity * holding.avgPrice);
            }, 0);
            
            const totalProfit = totalAssets - 100000; // Assuming starting cash was 100,000
            const totalReturn = totalInvested > 0 ? ((totalAssets - 100000) / totalInvested) * 100 : 0;
            
            document.getElementById('totalAssets').textContent = `${Math.round(totalAssets).toLocaleString()}원`;
            document.getElementById('totalProfit').textContent = `${Math.round(totalProfit).toLocaleString()}원`;
            document.getElementById('totalReturn').textContent = `${totalReturn.toFixed(2)}%`;
        }

        function getCurrentPrice(code, type) {
            // Simplified current price lookup - in real app would fetch from market data
            let allAssets = [];
            
            if (type === 'stock') {
                allAssets = [...STOCK_DATA.domestic, ...STOCK_DATA.international];
            } else if (type === 'crypto') {
                allAssets = CRYPTO_DATA;
            } else if (type === 'etf') {
                allAssets = ETF_DATA;
            }
            
            const asset = allAssets.find(a => a.code === code);
            return asset ? asset.price : 0;
        }

        // Refresh functions
        function refreshStockPrices(type) {
            const data = type === 'domestic' ? STOCK_DATA.domestic : STOCK_DATA.international;
            loadStockData(type, data);
        }

        function refreshCryptoPrices() {
            loadCryptoData();
        }

        function refreshETFPrices() {
            loadETFData();
        }
    </script>
</body>
</html>