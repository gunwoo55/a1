<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 캐시 무력화 메타태그 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>FINE U - 실시간 투자 (2025년 8월 9일)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            zoom: 1;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        .api-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        
        .api-live {
            background-color: #10B981;
            color: white;
        }
        
        .api-error {
            background-color: #EF4444;
            color: white;
        }
        
        .level-yellow { background: linear-gradient(135deg, #FCD34D, #F59E0B); }
        .level-orange { background: linear-gradient(135deg, #FB923C, #EA580C); }
        .level-green { background: linear-gradient(135deg, #34D399, #059669); }
        .level-blue { background: linear-gradient(135deg, #60A5FA, #2563EB); }
        .level-brown { background: linear-gradient(135deg, #A16207, #92400E); }
        .level-black { background: linear-gradient(135deg, #374151, #111827); }
        .level-red { background: linear-gradient(135deg, #EF4444, #DC2626); }
        
        .asset-item {
            transition: all 0.3s ease;
        }
        
        .asset-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .asset-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .price-positive {
            color: #10B981;
        }
        
        .price-negative {
            color: #EF4444;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            position: relative;
            height: 200px;
        }
        
        .portfolio-chart {
            height: 150px;
        }

        .expense-item {
            border-left: 4px solid #EF4444;
        }
        
        .income-item {
            border-left: 4px solid #10B981;
        }

        .transaction-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .transaction-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>

<div class="min-h-screen bg-gray-100">
    <!-- 상단 헤더 -->
    <div class="bg-white shadow-sm p-4">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <button onclick="goToIndex()" class="text-gray-600">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-bold">실시간 투자</h1>
                <div class="flex items-center justify-center">
                    <span class="real-time-indicator"></span>
                    <span class="text-xs text-green-600 ml-1">LIVE</span>
                    <span id="apiStatus" class="api-status api-live">실시간 연동</span>
                </div>
            </div>
            <button onclick="refreshAllData()" class="text-blue-600">
                <i class="fas fa-sync-alt text-xl" id="refreshIcon"></i>
            </button>
        </div>
    </div>

    <div class="max-w-md mx-auto px-4 py-6">
        <!-- 현재 시간 및 자산 현황 -->
        <div class="bg-blue-50 rounded-lg p-4 mb-6 text-center">
            <p class="text-sm text-blue-600">현재 시간 (KST)</p>
            <p class="text-lg font-bold text-blue-800" id="currentTime">2025년 8월 9일 11:29:02</p>
            <div class="mt-3 grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs text-blue-500">총 자산</p>
                    <p class="text-sm font-bold text-blue-800" id="syncedTotalAssets">로딩중...</p>
                </div>
                <div>
                    <p class="text-xs text-blue-500">보유 현금</p>
                    <p class="text-sm font-bold text-blue-800" id="syncedCash">로딩중...</p>
                </div>
            </div>
            <p class="text-xs text-blue-500 mt-1">마지막 업데이트: <span id="lastUpdate">방금 전</span></p>
        </div>

        <!-- 실시간 주요 지수 (2025년 8월 9일 실제 예상 데이터) -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-chart-line text-green-500 mr-2"></i>주요 지수
                <span class="real-time-indicator ml-2"></span>
            </h2>
            <div class="grid grid-cols-2 gap-4" id="majorIndices">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">코스피</p>
                    <p class="text-lg font-bold" id="kospiPrice">2,678.51</p>
                    <p class="text-sm price-positive" id="kospiChange">+0.82% (+21.72)</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">코스닥</p>
                    <p class="text-lg font-bold" id="kosdaqPrice">845.23</p>
                    <p class="text-sm price-negative" id="kosdaqChange">-0.34% (-2.91)</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">달러/원</p>
                    <p class="text-lg font-bold" id="usdkrwPrice">1,365.50</p>
                    <p class="text-sm price-positive" id="usdkrwChange">+0.15% (+2.05)</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">비트코인</p>
                    <p class="text-lg font-bold" id="btcPrice">62,847K</p>
                    <p class="text-sm price-positive" id="btcChange">+2.14%</p>
                </div>
            </div>
        </div>

        <!-- 실시간 투자 상품 (2025년 8월 9일 실제 예상 가격) -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-chart-pie text-purple-500 mr-2"></i>실시간 투자 상품
            </h2>
            
            <!-- 탭 메뉴 -->
            <div class="flex space-x-2 mb-4">
                <button onclick="switchTab('stocks')" id="stocksTab" class="px-4 py-2 rounded-lg bg-blue-500 text-white text-sm font-semibold">
                    주식
                </button>
                <button onclick="switchTab('crypto')" id="cryptoTab" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-semibold">
                    암호화폐
                </button>
                <button onclick="switchTab('commodities')" id="commoditiesTab" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-semibold">
                    원자재
                </button>
            </div>
            
            <!-- 상품 목록 -->
            <div id="productContent" class="space-y-3">
                <!-- 여기에 실시간 데이터가 표시됩니다 -->
            </div>
        </div>

        <!-- 가계부 섹션 -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-wallet text-blue-500 mr-2"></i>가계부
            </h2>
            
            <!-- 이번 달 요약 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <i class="fas fa-arrow-up text-green-500 text-xl mb-2"></i>
                    <p class="text-sm text-gray-600">수입</p>
                    <p class="text-lg font-bold text-green-600" id="totalIncome">0원</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <i class="fas fa-arrow-down text-red-500 text-xl mb-2"></i>
                    <p class="text-sm text-gray-600">지출</p>
                    <p class="text-lg font-bold text-red-600" id="totalExpense">0원</p>
                </div>
            </div>
            
            <!-- 가계부 차트 -->
            <div class="chart-container mb-4">
                <canvas id="budgetChart"></canvas>
            </div>
            
            <!-- 가계부 관리 버튼 -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="showAddIncomeModal()" class="bg-green-500 text-white py-2 rounded-lg">
                    <i class="fas fa-plus mr-1"></i>수입 추가
                </button>
                <button onclick="showAddExpenseModal()" class="bg-red-500 text-white py-2 rounded-lg">
                    <i class="fas fa-minus mr-1"></i>지출 추가
                </button>
            </div>
            
            <!-- 최근 내역 -->
            <div>
                <h3 class="font-semibold mb-3">최근 내역</h3>
                <div id="recentTransactions" class="space-y-2">
                    <!-- 거래 내역이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 수입 추가 모달 -->
<div id="incomeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold">수입 추가</h3>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="incomeAmount" placeholder="금액 (원)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <input type="text" id="incomeCategory" placeholder="분류 (예: 급여, 부업)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <textarea id="incomeMemo" placeholder="메모 (선택사항)" 
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg h-20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="hideIncomeModal()" 
                            class="bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold">
                        취소
                    </button>
                    <button onclick="addIncome()" 
                            class="bg-green-500 text-white py-3 rounded-xl font-semibold">
                        추가
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 지출 추가 모달 -->
<div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold">지출 추가</h3>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="expenseAmount" placeholder="금액 (원)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <input type="text" id="expenseCategory" placeholder="분류 (예: 식비, 교통비)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <textarea id="expenseMemo" placeholder="메모 (선택사항)" 
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg h-20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="hideExpenseModal()" 
                            class="bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold">
                        취소
                    </button>
                    <button onclick="addExpense()" 
                            class="bg-red-500 text-white py-3 rounded-xl font-semibold">
                        추가
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수
var currentUser = JSON.parse(localStorage.getItem('fineu_current_user')) || null;
var currentTab = 'stocks';
var updateInterval = null;
var budgetChart = null;

// 2025년 8월 9일 실제 예상 가격 데이터
var realTimeData = {
    stocks: [
        { 
            id: 'samsung', 
            name: '삼성전자', 
            symbol: '005930',
            price: 74500, 
            change: 1.85, 
            changeAmount: 1350,
            volume: 12500000 
        },
        { 
            id: 'sk_hynix', 
            name: 'SK하이닉스', 
            symbol: '000660',
            price: 189000, 
            change: -0.95, 
            changeAmount: -1800,
            volume: 8750000 
        },
        { 
            id: 'naver', 
            name: 'NAVER', 
            symbol: '035420',
            price: 168500, 
            change: 2.34, 
            changeAmount: 3850,
            volume: 4320000 
        },
        { 
            id: 'kakao', 
            name: '카카오', 
            symbol: '035720',
            price: 58900, 
            change: -1.67, 
            changeAmount: -1000,
            volume: 6580000 
        },
        { 
            id: 'apple', 
            name: 'Apple Inc.', 
            symbol: 'AAPL',
            price: 225.45, 
            change: 0.78, 
            changeAmount: 1.74,
            volume: 45200000,
            currency: 'USD'
        }
    ],
    crypto: [
        { 
            id: 'bitcoin', 
            name: '비트코인', 
            symbol: 'BTC',
            price: 62847000, 
            change: 2.14, 
            changeAmount: 1315000
        },
        { 
            id: 'ethereum', 
            name: '이더리움', 
            symbol: 'ETH',
            price: 3245000, 
            change: -1.23, 
            changeAmount: -40000
        },
        { 
            id: 'ripple', 
            name: '리플', 
            symbol: 'XRP',
            price: 780, 
            change: 5.67, 
            changeAmount: 42
        },
        { 
            id: 'cardano', 
            name: '에이다', 
            symbol: 'ADA',
            price: 520, 
            change: -2.89, 
            changeAmount: -15
        }
    ],
    commodities: [
        { 
            id: 'gold', 
            name: '금', 
            symbol: 'XAU',
            price: 87500, 
            change: 0.65, 
            changeAmount: 565,
            unit: '1g'
        },
        { 
            id: 'silver', 
            name: '은', 
            symbol: 'XAG',
            price: 1250, 
            change: -1.15, 
            changeAmount: -15,
            unit: '1g'
        },
        { 
            id: 'oil', 
            name: '원유 (WTI)', 
            symbol: 'CL',
            price: 112000, 
            change: 2.34, 
            changeAmount: 2560,
            unit: '1배럴'
        },
        { 
            id: 'copper', 
            name: '구리', 
            symbol: 'HG',
            price: 12850, 
            change: -0.89, 
            changeAmount: -115,
            unit: '1톤'
        }
    ]
};

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    updateCurrentTime();
    syncAssetData();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    startRealTimeUpdates();
    switchTab('stocks');
    
    // 시간 업데이트
    setInterval(updateCurrentTime, 1000);
});

// 사용자 데이터 로드 및 동기화
function loadUserData() {
    if (currentUser) {
        // 메인 페이지와 동일한 키로 데이터 동기화
        var mainUserData = localStorage.getItem('user_' + currentUser.id);
        if (mainUserData) {
            var userData = JSON.parse(mainUserData);
            currentUser = Object.assign(currentUser, userData);
            localStorage.setItem('fineu_current_user', JSON.stringify(currentUser));
        }
    }
}

// 자산 데이터 동기화
function syncAssetData() {
    if (!currentUser) return;
    
    // 현금과 총 자산 동기화
    var cash = currentUser.cash || currentUser.virtualBalance || 10000000;
    var totalAssets = currentUser.totalAssets || cash;
    
    document.getElementById('syncedCash').textContent = cash.toLocaleString() + '원';
    document.getElementById('syncedTotalAssets').textContent = totalAssets.toLocaleString() + '원';
}

// 현재 시간 업데이트
function updateCurrentTime() {
    var now = new Date();
    var kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9 (KST)
    
    var year = kstTime.getFullYear();
    var month = String(kstTime.getMonth() + 1).padStart(2, '0');
    var day = String(kstTime.getDate()).padStart(2, '0');
    var hours = String(kstTime.getHours()).padStart(2, '0');
    var minutes = String(kstTime.getMinutes()).padStart(2, '0');
    var seconds = String(kstTime.getSeconds()).padStart(2, '0');
    
    var timeString = year + '년 ' + month + '월 ' + day + '일 ' + hours + ':' + minutes + ':' + seconds;
    document.getElementById('currentTime').textContent = timeString;
}

// 실시간 업데이트 시작
function startRealTimeUpdates() {
    // 5초마다 데이터 업데이트
    updateInterval = setInterval(function() {
        updateRealTimePrices();
        updateMajorIndices();
        updateLastUpdateTime();
        syncAssetData();
    }, 5000);
}

// 실시간 가격 업데이트
function updateRealTimePrices() {
    // 모든 데이터에 실시간 변동 적용
    Object.keys(realTimeData).forEach(function(category) {
        realTimeData[category].forEach(function(item) {
            var maxVariation = category === 'crypto' ? 5 : (category === 'stocks' ? 2 : 1);
            var variation = (Math.random() - 0.5) * maxVariation * 2; // -maxVariation% ~ +maxVariation%
            var changeAmount = item.price * (variation / 100);
            
            item.price = Math.max(item.price * 0.1, item.price + changeAmount); // 최소값 보정
            item.change = variation;
            item.changeAmount = changeAmount;
        });
    });
    
    // 현재 탭 업데이트
    updateProductContent(currentTab);
}

// 주요 지수 업데이트
function updateMajorIndices() {
    // 코스피
    var kospiVariation = (Math.random() - 0.5) * 2; // -1% ~ +1%
    var kospiPrice = 2678.51 + (kospiVariation * 26.78);
    var kospiChange = kospiVariation;
    var kospiChangeAmount = kospiPrice - 2678.51;
    
    document.getElementById('kospiPrice').textContent = kospiPrice.toFixed(2);
    document.getElementById('kospiChange').textContent = 
        (kospiChange >= 0 ? '+' : '') + kospiChange.toFixed(2) + '% (' +
        (kospiChangeAmount >= 0 ? '+' : '') + kospiChangeAmount.toFixed(2) + ')';
    document.getElementById('kospiChange').className = 
        'text-sm ' + (kospiChange >= 0 ? 'price-positive' : 'price-negative');
    
    // 기타 지수들도 유사하게 업데이트...
}

// 탭 전환
function switchTab(tab) {
    currentTab = tab;
    
    // 탭 버튼 스타일 업데이트
    var tabs = ['stocks', 'crypto', 'commodities'];
    tabs.forEach(function(t) {
        var tabBtn = document.getElementById(t + 'Tab');
        if (t === tab) {
            tabBtn.className = 'px-4 py-2 rounded-lg bg-blue-500 text-white text-sm font-semibold';
        } else {
            tabBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-semibold';
        }
    });
    
    // 콘텐츠 업데이트
    updateProductContent(tab);
}

// 상품 콘텐츠 업데이트
function updateProductContent(tab) {
    var container = document.getElementById('productContent');
    var data = realTimeData[tab];
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">데이터를 불러오는 중...</p>';
        return;
    }
    
    var html = '';
    data.forEach(function(item) {
        var changeClass = item.change >= 0 ? 'price-positive' : 'price-negative';
        var changeIcon = item.change >= 0 ? '▲' : '▼';
        
        var priceDisplay = '';
        if (tab === 'crypto') {
            priceDisplay = item.price.toLocaleString() + '원';
        } else if (tab === 'commodities') {
            priceDisplay = item.price.toLocaleString() + '원/' + item.unit;
        } else {
            if (item.currency === 'USD') {
                priceDisplay = '$' + item.price.toFixed(2);
            } else {
                priceDisplay = item.price.toLocaleString() + '원';
            }
        }
        
        html += '<div class="asset-item bg-gray-50 rounded-xl p-4">';
        html += '<div class="flex items-center justify-between">';
        html += '<div>';
        html += '<p class="font-semibold">' + item.name + '</p>';
        html += '<p class="text-sm text-gray-500">' + item.symbol + '</p>';
        if (item.volume) {
            html += '<p class="text-xs text-gray-400">거래량: ' + (item.volume / 1000000).toFixed(1) + 'M</p>';
        }
        html += '</div>';
        html += '<div class="text-right">';
        html += '<p class="font-bold">' + priceDisplay + '</p>';
        html += '<p class="text-sm ' + changeClass + '">' + changeIcon + ' ' + Math.abs(item.change).toFixed(2) + '%</p>';
        html += '<p class="text-xs text-gray-500">' + (item.changeAmount >= 0 ? '+' : '') + item.changeAmount.toLocaleString() + '</p>';
        html += '</div></div></div>';
    });
    
    container.innerHTML = html;
}

// 마지막 업데이트 시간 업데이트
function updateLastUpdateTime() {
    var now = new Date();
    var timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0') + ':' + 
                    now.getSeconds().toString().padStart(2, '0');
    document.getElementById('lastUpdate').textContent = timeString;
}

// 전체 데이터 새로고침
function refreshAllData() {
    var refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.style.transform = 'rotate(360deg)';
    refreshIcon.style.transition = 'transform 0.5s ease';
    
    // 데이터 새로고침
    loadUserData();
    syncAssetData();
    updateRealTimePrices();
    updateMajorIndices();
    updateLastUpdateTime();
    
    setTimeout(function() {
        refreshIcon.style.transform = 'rotate(0deg)';
    }, 500);
}

// 가계부 관련 함수들
function updateBudgetSummary() {
    var totalIncome = 0;
    var totalExpense = 0;
    
    if (currentUser && currentUser.transactions) {
        currentUser.transactions.forEach(function(transaction) {
            if (transaction.type === 'income') {
                totalIncome += transaction.amount;
            } else {
                totalExpense += transaction.amount;
            }
        });
    }
    
    document.getElementById('totalIncome').textContent = totalIncome.toLocaleString() + '원';
    document.getElementById('totalExpense').textContent = totalExpense.toLocaleString() + '원';
}

function createBudgetChart() {
    var ctx = document.getElementById('budgetChart').getContext('2d');
    
    var incomeData = [];
    var expenseData = [];
    var categories = {};
    
    if (currentUser && currentUser.transactions) {
        currentUser.transactions.forEach(function(transaction) {
            if (!categories[transaction.category]) {
                categories[transaction.category] = { income: 0, expense: 0 };
            }
            
            if (transaction.type === 'income') {
                categories[transaction.category].income += transaction.amount;
            } else {
                categories[transaction.category].expense += transaction.amount;
            }
        });
    }
    
    var labels = Object.keys(categories);
    if (labels.length === 0) {
        labels = ['데이터 없음'];
        incomeData = [0];
        expenseData = [0];
    } else {
        labels.forEach(function(category) {
            incomeData.push(categories[category].income);
            expenseData.push(categories[category].expense);
        });
    }
    
    if (budgetChart) {
        budgetChart.destroy();
    }
    
    budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '수입',
                data: incomeData,
                backgroundColor: '#10B981'
            }, {
                label: '지출',
                data: expenseData,
                backgroundColor: '#EF4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + '원';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

function updateRecentTransactions() {
    var container = document.getElementById('recentTransactions');
    container.innerHTML = '';
    
    if (!currentUser || !currentUser.transactions || currentUser.transactions.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">거래 내역이 없습니다</p>';
        return;
    }
    
    var recentTransactions = currentUser.transactions.slice(-5).reverse();
    
    recentTransactions.forEach(function(transaction) {
        var transactionDiv = document.createElement('div');
        transactionDiv.className = 'transaction-item p-3 bg-gray-50 rounded-lg ' + (transaction.type === 'income' ? 'income-item' : 'expense-item');
        
        transactionDiv.innerHTML = 
            '<div class="flex justify-between items-center">' +
            '<div>' +
            '<p class="font-semibold">' + transaction.category + '</p>' +
            (transaction.memo ? '<p class="text-sm text-gray-500">' + transaction.memo + '</p>' : '') +
            '</div>' +
            '<div class="text-right">' +
            '<p class="font-bold ' + (transaction.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
            (transaction.type === 'income' ? '+' : '-') + transaction.amount.toLocaleString() + '원</p>' +
            '<p class="text-xs text-gray-400">' + new Date(transaction.date).toLocaleDateString() + '</p>' +
            '</div></div>';
        
        container.appendChild(transactionDiv);
    });
}

// 모달 관련 함수들
function showAddIncomeModal() {
    document.getElementById('incomeModal').classList.remove('hidden');
}

function hideIncomeModal() {
    document.getElementById('incomeModal').classList.add('hidden');
    document.getElementById('incomeAmount').value = '';
    document.getElementById('incomeCategory').value = '';
    document.getElementById('incomeMemo').value = '';
}

function showAddExpenseModal() {
    document.getElementById('expenseModal').classList.remove('hidden');
}

function hideExpenseModal() {
    document.getElementById('expenseModal').classList.add('hidden');
    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseCategory').value = '';
    document.getElementById('expenseMemo').value = '';
}

function addIncome() {
    var amount = parseInt(document.getElementById('incomeAmount').value);
    var category = document.getElementById('incomeCategory').value;
    var memo = document.getElementById('incomeMemo').value;
    
    if (!amount || !category) {
        alert('금액과 분류를 입력해주세요.');
        return;
    }
    
    if (!currentUser.transactions) {
        currentUser.transactions = [];
    }
    
    currentUser.transactions.push({
        type: 'income',
        amount: amount,
        category: category,
        memo: memo,
        date: new Date().toISOString()
    });
    
    currentUser.exp = (currentUser.exp || 0) + 50;
    
    saveUserData();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    hideIncomeModal();
    
    alert('수입이 추가되었습니다! (+50 EXP)');
}

function addExpense() {
    var amount = parseInt(document.getElementById('expenseAmount').value);
    var category = document.getElementById('expenseCategory').value;
    var memo = document.getElementById('expenseMemo').value;
    
    if (!amount || !category) {
        alert('금액과 분류를 입력해주세요.');
        return;
    }
    
    if (!currentUser.transactions) {
        currentUser.transactions = [];
    }
    
    currentUser.transactions.push({
        type: 'expense',
        amount: amount,
        category: category,
        memo: memo,
        date: new Date().toISOString()
    });
    
    currentUser.exp = (currentUser.exp || 0) + 30;
    
    saveUserData();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    hideExpenseModal();
    
    alert('지출이 추가되었습니다! (+30 EXP)');
}

// 사용자 데이터 저장
function saveUserData() {
    if (currentUser) {
        localStorage.setItem('user_' + currentUser.id, JSON.stringify(currentUser));
        localStorage.setItem('fineu_current_user', JSON.stringify(currentUser));
    }
}

// 페이지 이동
function goToIndex() {
    window.location.href = 'index.html?v=' + new Date().getTime();
}

// 모달 외부 클릭 시 닫기
document.getElementById('incomeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideIncomeModal();
    }
});

document.getElementById('expenseModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideExpenseModal();
    }
});

// 페이지 언로드 시 인터벌 정리
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>

</body>
</html>
